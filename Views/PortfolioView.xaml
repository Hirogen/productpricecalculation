<UserControl x:Class="ProductPriceCalculator.Views.PortfolioView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="800">
    <UserControl.Resources>
        <!-- Proxy element to allow DataGrid columns to access the DataContext -->
        <FrameworkElement x:Key="ProxyElement" DataContext="{Binding}"/>
    </UserControl.Resources>
    
    <StackPanel>
        <!-- Hidden ContentControl to place proxy in visual tree -->
        <ContentControl Visibility="Collapsed" Content="{StaticResource ProxyElement}"/>
        
        <!-- Header -->
        <TextBlock Text="{Binding HeaderProductPortfolio}"
                   FontSize="20"
                   FontWeight="Bold"
                   Margin="0,0,0,10"/>
        <Rectangle Height="2" Fill="#0078D7" Margin="0,0,0,15"/>

        <!-- Info Banner -->
        <Border Background="#E6F2FF"
                BorderBrush="#0078D7"
                BorderThickness="2"
                CornerRadius="5"
                Padding="10"
                Margin="0,0,0,15">
            <TextBlock Text="{Binding InfoPortfolio}"
                       TextWrapping="Wrap"
                       FontWeight="SemiBold"/>
        </Border>

        <!-- Product Selection -->
        <TextBlock Text="{Binding HeaderProductSelection}"
                   FontSize="14"
                   FontWeight="Bold"
                   Margin="0,0,0,10"/>

        <TextBlock Text="{Binding InfoSelectProducts}"
                   FontSize="12"
                   TextWrapping="Wrap"
                   Foreground="Gray"
                   Margin="0,0,0,10"/>

        <DataGrid ItemsSource="{Binding AvailableProducts}"
                  AutoGenerateColumns="False"
                  Height="200"
                  Margin="0,0,0,15">
            <DataGrid.Columns>
                <DataGridCheckBoxColumn Header="{Binding DataContext.ColSelected, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" 
                                        Width="80"/>
                <DataGridTextColumn Header="{Binding DataContext.ColProduct, Source={StaticResource ProxyElement}}" 
                                    Binding="{Binding Product.Name}" 
                                    Width="*" 
                                    IsReadOnly="True"/>
                <DataGridTextColumn Header="{Binding DataContext.ColBaseCost, Source={StaticResource ProxyElement}}" 
                                    Binding="{Binding Product.BaseCost, Converter={StaticResource CurrencyConverter}}" 
                                    Width="100" 
                                    IsReadOnly="True"/>
                <DataGridTextColumn Header="{Binding DataContext.ColMarkup, Source={StaticResource ProxyElement}}" 
                                    Binding="{Binding Product.Markup, StringFormat=F0}" 
                                    Width="80" 
                                    IsReadOnly="True"/>
                <DataGridTextColumn Header="{Binding DataContext.ColExpectedUnits, Source={StaticResource ProxyElement}}" 
                                    Binding="{Binding Product.ExpectedMonthlyUnits, StringFormat=F0}" 
                                    Width="130" 
                                    IsReadOnly="True"/>
            </DataGrid.Columns>
        </DataGrid>

        <Button Content="{Binding ButtonCalculatePortfolio}"
                Command="{Binding CalculatePortfolioCommand}"
                Style="{StaticResource PrimaryButtonStyle}"
                Width="250"
                Margin="0,0,0,20"
                HorizontalAlignment="Left"/>

        <!-- Results Section -->
        <StackPanel Visibility="{Binding HasResults, Converter={StaticResource BoolToVisibilityConverter}}">
            <TextBlock Text="{Binding HeaderPortfolioAnalysis}"
                       FontSize="16"
                       FontWeight="Bold"
                       Margin="0,10,0,10"/>

            <!-- Summary Info -->
            <Border Background="#FFFACD"
                    BorderBrush="#FFD700"
                    BorderThickness="2"
                    CornerRadius="5"
                    Padding="10"
                    Margin="0,0,0,15">
                <StackPanel>
                    <TextBlock FontSize="13" FontWeight="SemiBold">
                        <Run Text="{Binding LabelTotalPortfolioUnits, Mode=OneWay}"/>
                        <Run Text=" "/>
                        <Run Text="{Binding PortfolioResult.TotalUnits, StringFormat=F0}"/>
                    </TextBlock>
                    <TextBlock FontSize="13" FontWeight="SemiBold">
                        <Run Text="{Binding LabelDistributedOperatingCost, Mode=OneWay}"/>
                        <Run Text=" "/>
                        <Run Text="{Binding PortfolioResult.TotalOperatingCosts, Converter={StaticResource CurrencyConverter}}"/>
                        <Run Text="{Binding LabelPerMonth, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <!-- Results Grid -->
            <DataGrid ItemsSource="{Binding PortfolioResult.ProductResults}"
                      AutoGenerateColumns="False"
                      Height="250"
                      Margin="0,0,0,15"
                      IsReadOnly="True">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="{Binding DataContext.ColProductName, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding ProductName}" 
                                        Width="*"/>
                    <DataGridTextColumn Header="{Binding DataContext.ColExpectedUnits, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding ExpectedUnits, StringFormat=F0}" 
                                        Width="120"/>
                    <DataGridTextColumn Header="{Binding DataContext.ColPercentage, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding Percentage, StringFormat=F1}" 
                                        Width="90"/>
                    <DataGridTextColumn Header="{Binding DataContext.ColOperatingCostPerUnit, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding OperatingCostPerUnit, Converter={StaticResource CurrencyConverter}}" 
                                        Width="120"/>
                    <DataGridTextColumn Header="{Binding DataContext.ColFinalPrice, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding FinalPrice, Converter={StaticResource CurrencyConverter}}" 
                                        Width="100"/>
                    <DataGridTextColumn Header="{Binding DataContext.ColProfit, Source={StaticResource ProxyElement}}" 
                                        Binding="{Binding ProfitPerUnit, Converter={StaticResource CurrencyConverter}}" 
                                        Width="100"/>
                </DataGrid.Columns>
            </DataGrid>

            <!-- Explanation -->
            <Border Background="#E6F2FF"
                    BorderBrush="#0078D7"
                    BorderThickness="1"
                    CornerRadius="5"
                    Padding="10">
                <TextBlock Text="{Binding InfoPortfolio}"
                           TextWrapping="Wrap" 
                           FontSize="12"/>
            </Border>
        </StackPanel>
    </StackPanel>
</UserControl>
